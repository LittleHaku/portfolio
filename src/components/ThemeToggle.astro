---
import SunIcon from "./icons/SunIcon.astro";
import MoonIcon from "./icons/MoonIcon.astro";
import MonitorIcon from "./icons/MonitorIcon.astro";

const LABELS = ["Light", "Dark", "System"] as const;
type Theme = typeof LABELS[number];
---

<div class="relative ml-1 mr-1" data-theme-toggle-root>
  <button
    type="button"
    class="theme-toggle-btn appearance-none border-none flex items-center justify-center
           hover:scale-125 transition focus:outline-none"
    aria-haspopup="menu"
    aria-expanded="false"
  >
    <span class="sr-only">Toggle theme</span>

    <!-- We animate visibility by toggling opacity/scale -->
    <SunIcon data-icon="light" class="theme-toggle-icon size-5 transition-all opacity-0 scale-75" />
    <MoonIcon data-icon="dark" class="theme-toggle-icon absolute size-5 transition-all opacity-0 scale-75" />
    <MonitorIcon data-icon="system" class="theme-toggle-icon absolute size-5 transition-all opacity-0 scale-75" />
  </button>

  <div
    class="themes-menu absolute hidden origin-top-right top-8 right-0 text-sm p-1 min-w-32
           rounded-md border border-zinc-100 bg-white/90 dark:bg-zinc-900/90
           dark:border-zinc-500/20 shadow-[0_3px_10px_rgb(0,0,0,0.2)]
           backdrop-blur-md transition transform"
    role="menu"
  >
    <ul class="outline-none">
      {LABELS.map((label) => (
        <li
          class="themes-menu-option px-2 py-1.5 rounded-sm cursor-default select-none
                 hover:bg-neutral-400/40 dark:hover:bg-zinc-500/50 focus:bg-neutral-300/50
                 focus:dark:bg-zinc-600/50 outline-none"
          role="menuitem"
          tabindex="0"
          data-theme={label.toLowerCase()}
        >
          {label}
        </li>
      ))}
    </ul>
  </div>
</div>

<style is:global>
  /* tiny helpers for the icon swap */
  .theme-icon--active { opacity: 1 !important; transform: none !important; }
  .theme-icon--inactive { opacity: 0; transform: scale(0.75); pointer-events: none; }

  /* menu show / hide animations */
  .themes-menu[data-open="true"] {
    display: block !important;
    animation: tm-enter 140ms ease-out forwards;
  }
  .themes-menu[data-open="false"] {
    animation: tm-exit 120ms ease-in forwards;
  }
  @keyframes tm-enter { from { opacity: 0; translate: 0 -6px; } to { opacity: 1; translate: 0 0; } }
  @keyframes tm-exit  { from { opacity: 1; translate: 0 0; } to { opacity: 0; translate: 0 -6px; } }
</style>

<script is:inline>
  (function () {
    const roots = Array.from(document.querySelectorAll('[data-theme-toggle-root]'));
    if (!roots.length) return;

    function currentTheme() {
      const fromDataset = document.documentElement.dataset.theme;
      if (fromDataset === 'light' || fromDataset === 'dark' || fromDataset === 'system') {
        return fromDataset;
      }
      const stored = localStorage.getItem('theme');
      return stored === 'light' || stored === 'dark' || stored === 'system' ? stored : 'system';
    }

    function setIconForRoot(root, theme) {
      const icons = root.querySelectorAll('[data-icon]');
      icons.forEach((el) => {
        const key = el.dataset.icon;
        if (!key) return;
        if (key === theme) {
          el.classList.add('theme-icon--active');
          el.classList.remove('theme-icon--inactive');
        } else {
          el.classList.add('theme-icon--inactive');
          el.classList.remove('theme-icon--active');
        }
      });
    }

    function setIcons(theme) {
      roots.forEach((root) => setIconForRoot(root, theme));
    }

    function apply(theme) {
      if (typeof window.__setTheme === 'function') {
        window.__setTheme(theme);
      }
      setIcons(theme);
    }

    function bindRoot(root) {
      const btn = root.querySelector('.theme-toggle-btn');
      const menu = root.querySelector('.themes-menu');

      if (!btn || !menu || btn.dataset.themeToggleBound === 'true') return;
      btn.dataset.themeToggleBound = 'true';

      function openMenu() {
        menu.dataset.open = 'true';
        menu.classList.remove('hidden');
        btn.setAttribute('aria-expanded', 'true');

        const active = menu.querySelector(`[data-theme="${currentTheme()}"]`);
        (active ?? menu.querySelector('[role="menuitem"]'))?.focus();

        document.addEventListener('click', onOutsideClick, true);
        document.addEventListener('keydown', onKeydown, true);
      }

      function closeMenu() {
        menu.dataset.open = 'false';
        setTimeout(() => {
          if (menu.dataset.open === 'false') menu.classList.add('hidden');
        }, 140);
        btn.setAttribute('aria-expanded', 'false');

        document.removeEventListener('click', onOutsideClick, true);
        document.removeEventListener('keydown', onKeydown, true);
      }

      function toggleMenu() {
        const isOpen = menu.dataset.open === 'true';
        (isOpen ? closeMenu : openMenu)();
      }

      function onOutsideClick(e) {
        const target = e.target;
        if (!(target instanceof Node)) return;
        if (!root.contains(target)) closeMenu();
      }

      function onKeydown(e) {
        if (e.key === 'Escape') {
          closeMenu();
          return;
        }

        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          e.preventDefault();
          const items = Array.from(menu.querySelectorAll('[role="menuitem"]'));
          const idx = items.indexOf(document.activeElement);
          const next =
            e.key === 'ArrowDown'
              ? items[(idx + 1) % items.length]
              : items[(idx - 1 + items.length) % items.length];
          next?.focus();
        }

        if (e.key === 'Enter' || e.key === ' ') {
          const el = document.activeElement;
          if (el && el instanceof HTMLElement && el.dataset.theme) {
            e.preventDefault();
            apply(el.dataset.theme);
            closeMenu();
          }
        }
      }

      btn.addEventListener('click', (e) => {
        e.preventDefault();
        toggleMenu();
      });

      menu.querySelectorAll('.themes-menu-option').forEach((li) => {
        li.addEventListener('click', () => {
          const theme = li.dataset.theme;
          if (!theme) return;
          apply(theme);
          closeMenu();
        });
      });
    }

    // Bind all instances
    roots.forEach(bindRoot);

    // Initial icon state for all instances
    setIcons(currentTheme());

    // If you want icons to react when on System and the OS theme changes:
    const mql = window.matchMedia?.('(prefers-color-scheme: dark)');
    if (mql && typeof mql.addEventListener === 'function') {
      mql.addEventListener('change', (e) => {
        const theme = currentTheme();
        if (theme === 'system') {
          setIcons(e.matches ? 'dark' : 'light');
        }
      });
    }
  })();
</script>
