---
import Header from '../components/Header.astro'
import Footer from '../components/Footer.astro'
import '../styles/global.css'
import '@fontsource-variable/playfair-display'
import '@fontsource-variable/roboto'

interface Props {
  title: string
  description: string
  siteUrl: string
  ogImageUrl: string
  ogImageTwitter?: string
}

const { description, title, siteUrl, ogImageUrl, ogImageTwitter } = Astro.props

const siteName = 'Iván Sotillo - Software Engineer & AI Researcher'
const rawBaseUrl = (Astro.site?.toString() ?? siteUrl).replace(/\/+$/, '') // strip trailing slash for consistency
const baseUrl = rawBaseUrl.replace(/^http:\/\//i, 'https://') // prefer https to avoid insecure canonicals
const canonicalUrl = baseUrl + '/'
const resolvedOgImage = new URL(ogImageUrl, baseUrl + '/').toString()
const resolvedTwitterImage = new URL(ogImageTwitter ?? ogImageUrl, baseUrl + '/').toString()
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="title" content={title} />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#0f172a" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="sitemap" href="/sitemap-index.xml" />
    
    <!-- Open Graph -->
    <meta property="og:type"        content="website" />
    <meta property="og:title"       content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url"         content={canonicalUrl} />
    <meta property="og:image"       content={resolvedOgImage} />
    <meta property="og:site_name"   content={siteName} />
    <meta property="og:image:alt"   content={title} />

    <!-- Twitter -->
    <meta name="twitter:card"         content="summary_large_image" />
    <meta name="twitter:title"        content={title} />
    <meta name="twitter:description"  content={description} />
    <meta name="twitter:image"        content={resolvedTwitterImage} />

    <script type="application/ld+json">
      {JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Person",
        name: "Iván Sotillo del Horno",
        url: "https://ivansotillo.com",
        jobTitle: "Software Engineer & AI Researcher",
        sameAs: [
          "https://github.com/littlehaku",
          "https://www.linkedin.com/in/ivansotillo/",
        ],
      })}
    </script>
  </head>

  <body class="relative text-black dark:text-white min-h-screen">
    <!-- background layer (this is what actually changes) -->
    <div
      class="pointer-events-none fixed inset-0 -z-20
             bg-white
             dark:bg-zinc-950"
    ></div>

    <Header />
    <slot />
    <Footer />

    <style is:global>
      :root {
        /* we say we support both; avoids ugly scrollbars switching */
        color-scheme: light dark;
        --font-serif: "Playfair Display Variable", ui-serif, Georgia, serif;
        --font-sans: "Roboto Variable", ui-sans-serif, Helvetica, Arial, sans-serif;
      }

      html {
        font-family: var(--font-sans);
        font-weight: 400;
        scroll-behavior: smooth;
      }

      body {
        /* no hard background here — the layer above owns it */
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        overscroll-behavior: none;
      }
    </style>

    <script is:inline>
      // 3-state theme: light | dark | system
      const THEME_KEY = 'theme';
      const mql = window.matchMedia('(prefers-color-scheme: dark)');

      function applyTheme(theme) {
        const root = document.documentElement;

        if (theme === 'light') {
          root.classList.remove('dark');
          root.dataset.theme = 'light';
        } else if (theme === 'dark') {
          root.classList.add('dark');
          root.dataset.theme = 'dark';
        } else {
          // system
          root.dataset.theme = 'system';
          if (mql.matches) {
            root.classList.add('dark');
          } else {
            root.classList.remove('dark');
          }
        }
      }

      // init
      const stored = localStorage.getItem(THEME_KEY);
      applyTheme(stored || 'system');

      // if user changes system theme and we are in "system", update
      mql.addEventListener('change', () => {
        if (document.documentElement.dataset.theme === 'system') {
          applyTheme('system');
        }
      });

      // expose for your header toggle:
      // window.__setTheme('light' | 'dark' | 'system')
      window.__setTheme = (t) => {
        localStorage.setItem(THEME_KEY, t);
        applyTheme(t);
      };
    </script>
  </body>
</html>
